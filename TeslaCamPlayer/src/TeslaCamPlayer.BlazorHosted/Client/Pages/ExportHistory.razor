@page "/exports"
@using TeslaCamPlayer.BlazorHosted.Shared.Models
@inject HttpClient Http
@inject NavigationManager NavigationManager

<div class="pa-4" style="width:100%; height:100%; box-sizing:border-box;">
    <MudText Typo="Typo.h5" Class="mb-2">Export History</MudText>
    <MudTable Items="_items" Dense="true" Hover="true">
        <HeaderContent>
            <MudTh>File</MudTh>
            <MudTh>Location</MudTh>
            <MudTh>Created (UTC)</MudTh>
            <MudTh>Size</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Progress</MudTh>
            <MudTh>Action</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="File">@context.FileName</MudTd>
            <MudTd DataLabel="Location">@(!string.IsNullOrWhiteSpace(context.Location) ? context.Location : "-")</MudTd>
            <MudTd DataLabel="Created">@context.CreatedUtc.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
            <MudTd DataLabel="Size">@FormatSize(context.SizeBytes)</MudTd>
            <MudTd DataLabel="Status">@context.Status?.State.ToString()</MudTd>
            <MudTd DataLabel="Progress">
                @if (context.Status?.State == ExportState.Running || context.Status?.State == ExportState.Pending)
                {
                    <MudProgressLinear Value="@(context.Status?.Percent ?? 0)" />
                }
            </MudTd>
            <MudTd DataLabel="Action">
                <div class="d-flex gap-2">
                    @if (context.Status?.State == ExportState.Completed && !string.IsNullOrWhiteSpace(context.Url))
                    {
                        <MudButton Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined" Href="@context.Url" Target="_blank">Download</MudButton>
                    }
                    @if (!string.IsNullOrWhiteSpace(context.EventPath))
                    {
                        <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" OnClick="@(() => OpenEvent(context.EventPath))">Open Event</MudButton>
                    }
                    @if ((context.Status?.State == ExportState.Running || context.Status?.State == ExportState.Pending) && !_canceling.Contains(context.JobId))
                    {
                        <MudButton Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined" OnClick="@(() => CancelAsync(context.JobId))">Cancel</MudButton>
                    }
                    @if (_canceling.Contains(context.JobId))
                    {
                        <MudButton Size="Size.Small" Disabled="true" Variant="Variant.Outlined">Cancelling…</MudButton>
                    }
                    @if (context.Status?.State == ExportState.Completed && !_deleting.Contains(context.JobId))
                    {
                        <MudButton Size="Size.Small" Color="Color.Error" Variant="Variant.Outlined" OnClick="@(() => DeleteAsync(context.JobId))">Delete</MudButton>
                    }
                    @if (_deleting.Contains(context.JobId))
                    {
                        <MudButton Size="Size.Small" Disabled="true" Variant="Variant.Outlined">Deleting…</MudButton>
                    }
                </div>
            </MudTd>
        </RowTemplate>
    </MudTable>
</div>

@code {
    public class ExportItemVm
    {
        public string FileName { get; set; }
        public string Url { get; set; }
        public long SizeBytes { get; set; }
        public DateTime CreatedUtc { get; set; }
        public string JobId { get; set; }
        public ExportStatus Status { get; set; }
        public string Location { get; set; }
        public string EventPath { get; set; }
    }

    private List<ExportItemVm> _items = new();
    private System.Timers.Timer _timer;
    private readonly HashSet<string> _canceling = new();
    private readonly HashSet<string> _deleting = new();

    protected override async Task OnInitializedAsync()
    {
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += async (_, __) => await InvokeAsync(async () => await LoadAsync());
        _timer.Enabled = true;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            var data = await Http.GetFromJsonAsync<List<ExportItemVm>>("Api/ListExports");
            _items = data ?? new List<ExportItemVm>();

            // Clean up tracking sets
            _canceling.RemoveWhere(id => _items.All(x => x.JobId != id || (x.Status?.State != ExportState.Running && x.Status?.State != ExportState.Pending)));
            _deleting.RemoveWhere(id => _items.All(x => x.JobId != id));

            StateHasChanged();
        }
        catch { }
    }

    private static string FormatSize(long bytes)
    {
        string[] units = { "B", "KB", "MB", "GB" };
        double size = bytes;
        int unit = 0;
        while (size >= 1024 && unit < units.Length - 1)
        {
            size /= 1024;
            unit++;
        }
        return $"{size:0.##} {units[unit]}";
    }

    private async Task CancelAsync(string jobId)
    {
        if (string.IsNullOrWhiteSpace(jobId) || _canceling.Contains(jobId)) return;

        _canceling.Add(jobId);
        StateHasChanged();

        try
        {
            await Http.PostAsync($"Api/CancelExport?jobId={Uri.EscapeDataString(jobId)}", new StringContent(string.Empty));
        }
        catch { }
        finally
        {
            // LoadAsync will clean up the _canceling set
        }
    }

    private async Task DeleteAsync(string jobId)
    {
        if (string.IsNullOrWhiteSpace(jobId) || _deleting.Contains(jobId)) return;

        _deleting.Add(jobId);
        StateHasChanged();

        try
        {
            var response = await Http.DeleteAsync($"Api/DeleteExport?jobId={Uri.EscapeDataString(jobId)}");
            if (response.IsSuccessStatusCode)
            {
                // Remove from list and reload
                await LoadAsync();
            }
        }
        catch { }
        finally
        {
            _deleting.Remove(jobId);
            StateHasChanged();
        }
    }

    private void OpenEvent(string eventPath)
    {
        if (!string.IsNullOrWhiteSpace(eventPath))
        {
            NavigationManager.NavigateTo($"/?eventPath={Uri.EscapeDataString(eventPath)}");
        }
    }
}
