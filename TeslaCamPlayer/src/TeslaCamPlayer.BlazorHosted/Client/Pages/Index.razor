@page "/"
@using TeslaCamPlayer.BlazorHosted.Shared.Models
@inject IDialogService DialogService

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleExportMode">
            <MudIcon Icon="@Icons.Material.Filled.FileUpload" Class="mr-2" /> Export Video
        </MudButton>
        @if (_isExportMode)
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Inherit" Class="ml-2" OnClick="@OpenExportDialog">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" /> Video Export
            </MudButton>
        }
        <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="ml-2" OnClick="@OpenExportHistoryDialog">History</MudButton>
        <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Color="Color.Inherit" Href="https://github.com/megabitus98/docker-teslacamplayer" Target="_blank" />
        <MudText Typo="Typo.h6" Class="ml-2">@AssemblyVersion</MudText>
    </MudAppBar>
    <MudDrawer @bind-Open="@_isBrowserCollapsed" Elevation="1">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">TeslaCamPlayer</MudText>
        </MudDrawerHeader>
        @if (_filteredclips == null)
        {
            <div class="loading-screen">
                <MudText Typo="Typo.body1" Class="mb-2">Refreshing events...</MudText>
                <MudProgressLinear Color="Color.Default" Indeterminate="@(_refreshStatus.Total <= 0)"
                                    Value="@(_refreshStatus.Total > 0 ? ((double)_refreshStatus.Processed / _refreshStatus.Total) * 100d : 0)" />
                @if (_refreshStatus.Total > 0)
                {
                    <MudText Typo="Typo.body2" Class="mt-2">@_refreshStatus.Processed / @_refreshStatus.Total</MudText>
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mt-2">Indexing events, this can take a while depending on how many videos there are to index!</MudText>
                }
            </div>
        }
        else
        {
            <MudDatePicker @ref="_datePicker" PickerVariant="PickerVariant.Static" IsDateDisabledFunc="IsDateDisabledFunc"
                           FirstDayOfWeek="DayOfWeek.Monday" Class="browser-date-picker" DateChanged="DatePicked"
                           @onmousewheel="@DatePickerOnMouseWheel" />

            <MudToolBar Class="py-2">
                <MudTooltip Text="Refresh Events">
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh" Size="Size.Small"
                                   OnClick="@(() => RefreshEventsAsync(true))" />
                </MudTooltip>
                @if (_enableDelete)
                {
                    <MudTooltip Text="Delete Selected Event">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                       OnClick="@OpenDeleteConfirmationDialog" />
                    </MudTooltip>
                }
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.FilterAlt" Size="Size.Small" OnClick="@ToggleFilter" />

                <MudPopover @bind-Open="_showFilter" AnchorOrigin="Origin.CenterLeft"
                            TransformOrigin="Origin.CenterRight" Class="pa-4">
                    <div class="d-flex flex-column" style="gap: 16px;">
                        <EventFilter Values="_eventFilter" ValuesChanged="EventFilterValuesChanged" />
                        <CameraFilter Values="_cameraFilter" ValuesChanged="CameraFilterValuesChanged" />
                    </div>
                </MudPopover>
                <MudOverlay @bind-Visible="_showFilter" OnClick="ToggleFilter" />
            </MudToolBar>

            @if (_refreshStatus?.IsRefreshing == true)
            {
                <div class="px-3 pb-1">
                    <MudProgressLinear Dense="true" Color="Color.Default"
                        Indeterminate="@(_refreshStatus.Total <= 0)"
                        Value="@(_refreshStatus.Total > 0 ? ((double)_refreshStatus.Processed / _refreshStatus.Total) * 100d : 0)" />
                    @if (_refreshStatus.Total > 0)
                    {
                        <MudText Typo="Typo.caption" Class="mt-1">Indexing @_refreshStatus.Processed / @_refreshStatus.Total</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Class="mt-1">Indexing events…</MudText>
                    }
                </div>
            }

            <div @ref="_eventsList" class="events-list" @onscroll="EventListScrolled">
                <Virtualize TItem="Clip" ItemSize="@EventItemHeight" Items="@_filteredclips" OverscanCount="10">
                    <ItemContent>
                        <div class="event @(_activeClip == context ? "event--active" : null)" @key="@context.EndDate"
                             @onclick="@(() => SetActiveClip(context))">
                            @if (!string.IsNullOrWhiteSpace(context.ThumbnailUrl))
                            {
                                <img class="thumbnail" src="@context.ThumbnailUrl" loading="lazy" />
                            }
                            <div class="details ml-2">
                                <div class="icons">
                                    @foreach (var icon in GetClipIcons(context))
                                    {
                                        <MudIcon Icon="@icon" Size="Size.Small" Class="mr-1" />
                                    }
                                </div>
                                <div class="date">
                                    @((context.Event?.Timestamp ?? context.StartDate).ToString("dd MMM yy h:mm tt"))
                                </div>
                                <div class="location">
                                    @context.Event?.City
                                </div>
                            </div>
                        </div>
                    </ItemContent>
                    <Placeholder>
                        <div class="event">
                            <MudSkeleton Class="thumbnail" Width="66.66px" />
                            <div class="details ml-2">
                                <div class="icons">
                                    <MudSkeleton Width="20%" />
                                </div>
                                <div class="date">
                                    <MudSkeleton Width="80%" />
                                </div>
                            </div>
                        </div>
                    </Placeholder>
                </Virtualize>
            </div>
        }
    </MudDrawer>
    @* Export settings moved to a pop-out dialog opened via the toolbar button *@
    <MudMainContent Class="viewer-container">
        <ClipViewer @ref="_clipViewer" PreviousButtonClicked="PreviousButtonClicked"
            NextButtonClicked="NextButtonClicked" CameraFilter="_cameraFilter" IsExportMode="@_isExportMode" />
    </MudMainContent>
</MudLayout>

@code {
    private bool _isBrowserCollapsed = true;

    private void ToggleDrawer()
    {
        _isBrowserCollapsed = !_isBrowserCollapsed;
    }
}
