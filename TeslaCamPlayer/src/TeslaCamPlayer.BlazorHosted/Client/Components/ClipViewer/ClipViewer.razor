@namespace TeslaCamPlayer.BlazorHosted.Client.Components
@using TeslaCamPlayer.BlazorHosted.Shared.Models

<div class="viewer">
    <div class="video-container">
        <!--
            Responsive auto-fit grid of camera tiles.
            When a tile enters fullscreen, apply class 'fullscreen-active' on the grid and 'is-fullscreen' on the active tile.
        -->
        <div class="video-grid @(IsFullscreen ? "fullscreen-active" : null) @(IsGridLocked ? "grid-locked" : null)" style="@GridStyle()" @ref="_gridElement">
            @foreach (var tile in _tiles)
            {
                <div class="grid-tile @GetTileCss(tile.Tile) @(IsTileVisible(tile.Tile) ? null : "is-hidden")"
                     data-camera="@tile.DataCamera" data-visible="@(IsTileVisible(tile.Tile).ToString().ToLower())"
                     role="button" tabindex="0" aria-label="View @tile.Label fullscreen"
                     @ref="tile.ElementRef"
                     style="@GetTileStyle(tile)"
                     @onclick="@(() => ToggleFullscreen(tile.Tile))"
                     @onkeydown="@(e => TileKeyDown(e, tile.Tile))">
                    <VideoPlayer @key="@tile.VideoKey" @ref="tile.Player" Class="grid-video" VideoEnded="VideoEnded" TimeUpdate="ActiveVideoTimeUpdate" />
                    @if (IsTileVisible(tile.Tile))
                    {
                        <div class="tile-label"><span class="tile-label__text">@tile.Label</span></div>
                    }
                </div>
            }
        </div>

        @if (IsFullscreen)
        {
            <button class="fullscreen-close" aria-label="Close fullscreen" title="Close"
                    @onclick="ExitFullscreen">
                ✕
            </button>
        }

        @if (!IsExportMode)
        {
            <SeiHud @ref="_seiHudRef"
                    IsVisible="@_showSeiHud"
                    IsVisibleChanged="@OnSeiHudVisibilityChanged" />
        }
    </div>
    <div class="controls">
        @if (IsExportMode)
        {
            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">Export Mode Active — select a time range below</MudAlert>
        }
        <div class="play-pause">
            <MudIconButton Icon="@Icons.Material.Filled.SkipPrevious" Size="Size.Large" OnClick="@PreviousButtonClicked" />
            <MudIconButton Icon="@Icons.Material.Filled.Replay10" Size="Size.Medium" OnClick="@SkipBackwardTenSeconds" />
            <MudIconButton Icon="@(_isPlaying ? Icons.Material.Filled.PauseCircleOutline : Icons.Material.Filled.PlayCircleOutline)" Size="Size.Large" OnClick="@PlayPauseClicked" />
            <MudIconButton Icon="@Icons.Material.Filled.Forward10" Size="Size.Medium" OnClick="@SkipForwardTenSeconds" />
            <MudIconButton Icon="@Icons.Material.Filled.SkipNext" Size="Size.Large" OnClick="@NextButtonClicked" />
            <MudTooltip Text="Jump to event marker">
                <MudIconButton Icon="@Icons.Material.Filled.RadioButtonChecked" Size="Size.Medium" OnClick="@JumpToEventMarker" />
            </MudTooltip>
            <MudTooltip Text="@(IsGridLocked ? "Grid locked — tiles stay fixed" : "Grid scaling — layout adapts to visible cameras")"
                        Class="grid-toggle-wrapper">
                <MudIconButton Icon="@(IsGridLocked ? Icons.Material.Filled.GridOn : Icons.Material.Filled.GridView)"
                               Size="Size.Medium"
                               Variant="Variant.Outlined"
                               Color="@(IsGridLocked ? Color.Primary : Color.Default)"
                               AriaLabel="@(IsGridLocked ? "Grid locked" : "Grid scaling")"
                               OnClick="@ToggleGridMode"
                               Class="grid-mode-toggle" />
            </MudTooltip>
            <MudTooltip Text="@(_showSeiHud ? "Hide telemetry HUD" : "Show telemetry HUD")">
                <MudIconButton Icon="@Icons.Material.Filled.Sensors"
                               Size="Size.Medium"
                               Variant="Variant.Outlined"
                               Color="@(_showSeiHud ? Color.Primary : Color.Default)"
                               AriaLabel="@(_showSeiHud ? "Hide HUD" : "Show HUD")"
                               OnClick="@ToggleSeiHud" />
            </MudTooltip>
            <MudBadge Content="@(_playbackSpeed != 1.0 ? $"{_playbackSpeed:0.##}x" : null)"
                      Visible="@(_playbackSpeed != 1.0)"
                      Color="Color.Secondary"
                      Overlap="true"
                      Class="playback-speed-badge">
                <MudMenu Icon="@Icons.Material.Filled.Speed" Size="Size.Medium" AnchorOrigin="Origin.TopCenter" TransformOrigin="Origin.BottomCenter">
                    <MudMenuItem OnClick="@(() => SetPlaybackSpeedAsync(0.25))">0.25x</MudMenuItem>
                    <MudMenuItem OnClick="@(() => SetPlaybackSpeedAsync(0.5))">0.5x</MudMenuItem>
                    <MudMenuItem OnClick="@(() => SetPlaybackSpeedAsync(0.75))">0.75x</MudMenuItem>
                    <MudMenuItem OnClick="@(() => SetPlaybackSpeedAsync(1.0))">1.0x (Normal)</MudMenuItem>
                    <MudMenuItem OnClick="@(() => SetPlaybackSpeedAsync(1.25))">1.25x</MudMenuItem>
                    <MudMenuItem OnClick="@(() => SetPlaybackSpeedAsync(1.5))">1.5x</MudMenuItem>
                    <MudMenuItem OnClick="@(() => SetPlaybackSpeedAsync(1.75))">1.75x</MudMenuItem>
                    <MudMenuItem OnClick="@(() => SetPlaybackSpeedAsync(2.0))">2.0x</MudMenuItem>
                </MudMenu>
            </MudBadge>
        </div>
        @if (IsExportMode)
        {
            <div class="timeline-info-bar d-flex align-center justify-space-between mb-1" style="gap:16px; width: 100%; max-width: 1100px;">
                <div class="d-flex align-center" style="gap:16px;">
                    <MudText Typo="Typo.caption" Class="timeline-label">
                        <strong>Current:</strong> @GetCurrentScrubTime()
                    </MudText>
                    <MudText Typo="Typo.caption" Class="timeline-label export-start">
                        <strong>Export Start:</strong> @ExportStartDisplay()
                    </MudText>
                    <MudText Typo="Typo.caption" Class="timeline-label export-end">
                        <strong>Export End:</strong> @ExportEndDisplay()
                    </MudText>
                </div>
                <MudText Typo="Typo.caption" Class="timeline-label">
                    <strong>Duration:</strong> @ExportDurationDisplay()
                </MudText>
            </div>
        }
        <div class="seeker-slider-container @(IsExportMode ? "export-mode" : "")">
            <div class="current-time-container">@(_clip?.StartDate.ToString("hh:mm:ss tt"))</div>
            <div class="slider-container"
                 @ref="_sliderContainerRef"
                 @onpointermove="@OnSliderContainerPointerMove"
                 @onpointerup="@OnSliderContainerPointerUp"
                 @onpointercancel="@OnSliderContainerPointerUp">
                @if (IsExportMode)
                {
                    <div class="export-range-highlight" style="@ExportRangeHighlightStyle()"></div>
                    <div class="export-range-marker export-start-marker"
                         style="@ExportStartMarkerStyle()"
                         title="Drag to adjust export start time"
                         @onpointerdown="@OnExportStartMarkerPointerDown"
                         @onpointerdown:stopPropagation="true">
                        <div class="marker-handle"></div>
                    </div>
                    <div class="export-range-marker export-end-marker"
                         style="@ExportEndMarkerStyle()"
                         title="Drag to adjust export end time"
                         @onpointerdown="@OnExportEndMarkerPointerDown"
                         @onpointerdown:stopPropagation="true">
                        <div class="marker-handle"></div>
                    </div>
                }
                <MudSlider T="double"
                           Max="@_timelineMaxSeconds"
                           Step="0.01"
                           Size="Size.Medium"
                           @bind-Value="@TimelineValue"
                           Variant="Variant.Filled"
                           @onpointerdown="@TimelineSliderPointerDown"
                           @onpointerup="@TimelineSliderPointerUp" />
                <div class="event-marker" style="@EventMarkerStyle()"></div>
                @foreach (var segment in _clip?.Segments ?? Array.Empty<ClipVideoSegment>())
                {
                    <div class="segment-marker" style="@SegmentStartMarkerStyle(segment)"></div>
                }
            </div>
            <div class="time-container">
                @_clip?.EndDate.ToString("hh:mm:ss tt")
            </div>
        </div>
    </div>
</div>
